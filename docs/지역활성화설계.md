# 이벤트, 시즌, 위치 처리 설계서

본 문서는 `module-quest` 도메인에서 이벤트, 시즌, 지역 기반 퀘스트 노출 및 사용자 선택 제약을 도입하기 위한 도메인 구조와 API, 로직 설계를 정의한다.

---

## 1. Entity 설계

### 1.1 `QuestType`

* 퀘스트 유형은 다중 선택 가능하며 다음과 같은 분류가 존재한다.
* 예: 일반 퀘스트, 반복 퀘스트, 이벤트 퀘스트

```kotlin
enum class QuestType {
    NORMAL, REPEAT, EVENT
}
```

* `QuestEntity` 내 필드 정의:

```kotlin
@ElementCollection(fetch = FetchType.EAGER)
@CollectionTable(name = "quest_type_mapping", joinColumns = [JoinColumn(name = "quest_id")])
@Column(name = "type")
@Enumerated(EnumType.STRING)
var types: Set<QuestType> = mutableSetOf()
```

---

### 1.2 `EventEntity`

* 이벤트는 퀘스트와 배너에 공통으로 연계될 수 있는 메타 도메인이다.
* 시간 및 지역 범위를 포함한다.

```kotlin
@Entity
@Table(name = "event")
class EventEntity(
    @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
    val id: Long? = null,

    val name: String,
    val description: String?,
    val startDate: LocalDateTime,
    val endDate: LocalDateTime,
    val activeYn: Boolean = true,

    val regionName: String,
    val regionCode: String,
    val areaName: String,
    val areaCode: String
)
```

---

### 1.3 `BannerType` & `BannerEntity`

* 배너는 일반, 이벤트, 광고 타입으로 구분되며, 이벤트와 연계될 수 있다.

```kotlin
enum class BannerType {
    DEFAULT, EVENT, AD
}

@Entity
@Table(name = "banner")
class BannerEntity(
    @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
    val id: Long? = null,

    val title: String,
    val imageUrl: String,
    val type: BannerType,

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "event_id")
    val event: EventEntity? = null
)
```

---

### 1.4 `UserDailyZone`

* 사용자는 시즌 중 하나의 일상존을 선택해야 하며, 일단 선택하면 변경할 수 없다.
* 일상존은 문자열 기반 지역 정보로 구성된다.

```kotlin
@Entity
@Table(name = "user_daily_zone")
class UserDailyZoneEntity(
    @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
    val id: Long? = null,

    val userId: Long,

    val regionName: String,
    val regionCode: String,
    val areaName: String,
    val areaCode: String,

    val selectedAt: LocalDateTime
)
```

---

## 2. API 설계 (CRUD 및 비즈니스)

### 2.1 이벤트 관리

| 메서드    | URL                | 설명        |
| ------ | ------------------ | --------- |
| GET    | `/api/events`      | 이벤트 목록 조회 |
| GET    | `/api/events/{id}` | 이벤트 상세 조회 |
| POST   | `/api/events`      | 이벤트 생성    |
| PUT    | `/api/events/{id}` | 이벤트 수정    |
| DELETE | `/api/events/{id}` | 이벤트 삭제    |

---

### 2.2 배너 등록 시 이벤트 연동

| 메서드  | URL                       | 설명                              |
| ---- | ------------------------- | ------------------------------- |
| POST | `/api/banners`            | 배너 등록 (`type`, `eventId` 포함 가능) |
| GET  | `/api/banners?type=EVENT` | 이벤트용 배너 조회                      |

---

### 2.3 사용자 일상존 관리

| 메서드  | URL                              | 설명                 |
| ---- | -------------------------------- | ------------------ |
| POST | `/api/users/{userId}/daily-zone` | 일상존 최초 선택 (1회만 가능) |
| GET  | `/api/users/{userId}/daily-zone` | 사용자의 일상존 조회        |

> ⚠️ 일상존은 한 번만 등록할 수 있고, 이후 수정은 불가하다.

---

## 3. 주요 로직 설계

### 3.1 퀘스트 다중 타입 필터링

* `QuestType`은 다중 값으로 저장되며 다음 조건으로 필터링한다.

```kotlin
fun findQuestsByType(type: QuestType): List<QuestEntity> {
    return questRepository.findByTypesContaining(type)
}
```

---

### 3.2 현재 유효한 이벤트 조건

```kotlin
fun isEventActive(event: EventEntity, now: LocalDateTime): Boolean {
    return event.activeYn && now.isAfter(event.startDate) && now.isBefore(event.endDate)
}
```

---

### 3.3 일상존 등록 제한

```kotlin
fun registerUserDailyZone(userId: Long, zone: DailyZoneCommand) {
    if (userDailyZoneRepository.existsByUserId(userId)) {
        throw IllegalStateException("이미 일상존이 등록된 사용자입니다.")
    }
    userDailyZoneRepository.save(zone.toEntity(userId))
}
```